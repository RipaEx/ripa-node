<!DOCTYPE html>

<html>
<head>
  <title>app.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="arkio.css" />
</head>
<body>
  
    <div id="title">
         <h1>app.js</h1>
         <img src="https://ark.io/wp-content/uploads/2016/10/ark-normal.png">
        <hr>
    </div>
  
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="README.html">
                  README.md
                </a>
              
                
                <a class="source" href="app.html">
                  app.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        <li id="section-1">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>'use strict';

var appConfig = require('./config.json');
var networks = require('./networks.json');
var async = require('async');
var checkIpInList = require('./helpers/checkIpInList.js');
var extend = require('extend');
var fs = require('fs');
var genesisblock = require('./genesisBlock.json');
var ripajs = require('ripajs');
var https = require('https');
var Logger = require('./logger.js');
var packageJson = require('./package.json');
var path = require('path');
var program = require('commander');
var Sequence = require('./helpers/sequence.js');
var util = require('util');
var z_schema = require('./helpers/z_schema.js');
var colors = require('colors');
var vorpal = require('vorpal')();
var spawn = require('child_process').spawn;

process.stdin.resume();

var versionBuild = fs.readFileSync(path.join(__dirname, 'build'), 'utf8');

program
	.version(packageJson.version)
	.option('-c, --config &lt;path&gt;', 'config file path')
	.option('-g, --genesis &lt;path&gt;', 'genesis block')
	.option('-n, --networks &lt;path&gt;', 'networks definition file')
	.option('-p, --port &lt;port&gt;', 'listening port number')
	.option('-a, --address &lt;ip&gt;', 'listening host name or ip')
	.option('-x, --peers [peers...]', 'peers list')
	.option('-l, --log &lt;level&gt;', 'log level')
	.option('-i, --interactive', 'launch cli')
	.parse(process.argv);

if (program.config) {
	appConfig = require(path.resolve(process.cwd(), program.config));
}

if (program.genesis) {
	genesisblock = require(path.resolve(process.cwd(), program.genesis));
}

if (program.networks) {
	networks = require(path.resolve(process.cwd(), program.networks));
}

if (program.port) {
	appConfig.port = program.port;
}

if (program.address) {
	appConfig.address = program.address;
}

if (program.peers) {
	if (typeof program.peers === 'string') {
		appConfig.peers.list = program.peers.split(',').map(function (peer) {
			peer = peer.split(':');
			return {
				ip: peer.shift(),
				port: peer.shift() || appConfig.port
			};
		});
	} else {
		appConfig.peers.list = [];
	}
}

if (program.log) {
	appConfig.consoleLogLevel = program.log;
}

if (program.interactive) {
	appConfig.consoleLogLevel = "none";
}

var config = {
	db: appConfig.db,
	modules: {
		accounts: './modules/accounts.js',
		transactions: './modules/transactions.js',
		blocks: './modules/blocks.js',
		signatures: './modules/signatures.js',
		transport: './modules/transport.js',
		loader: './modules/loader.js',
		system: './modules/system.js',
		peers: './modules/peers.js',
		delegates: './modules/delegates.js',
		rounds: './modules/rounds.js',
		multisignatures: './modules/multisignatures.js',
		transactionPool: './modules/transactionPool.js',
		blockchain: './modules/blockchain.js',
		nodeManager: './modules/nodeManager.js'
	}
};

if(appConfig.network){
	appConfig.network = networks[appConfig.network];
}

else {
	appConfig.network = networks.ripa;
}

if(appConfig.modules){
	for(var name in appConfig.modules){
		config.modules[name]=appConfig.modules[name];
	}
}

var logger = new Logger({ echo: appConfig.consoleLogLevel, errorLevel: appConfig.fileLogLevel, filename: appConfig.logFileName });

var d = require('domain').create();

d.on('error', function (err) {
	logger.fatal('Domain master', { message: err.message, stack: err.stack });
	process.exit(0);
});

d.run(function () {
	var modules = [];
	console.log(colors.cyan("\n\
      {_       {_______    {__   {__       {___     {__    {____     {_____    {________\n\
     {_ __     {__    {__  {__  {__        {_ {__   {__  {__    {__  {__   {__ {__\n\
    {_  {__    {__    {__  {__ {__         {__ {__  {__{__        {__{__    {__{__\n\
   {__   {__   {_ {__      {_ {_           {__  {__ {__{__        {__{__    {__{______\n\
  {______ {__  {__  {__    {__  {__        {__   {_ {__{__        {__{__    {__{__\n\
 {__       {__ {__    {__  {__   {__       {__    {_ __  {__     {__ {__   {__ {__\n\
{__         {__{__      {__{__     {__     {__      {__    {____     {_____    {________\n\
\n\n\
	                     W E L C O M E  A B O A R D !\n\
\n\
"));
	async.auto({
		config: function (cb) {
			try {
				appConfig.nethash = new Buffer(genesisblock.payloadHash, 'hex').toString('hex');
			} catch (e) {
				logger.error('Failed to assign nethash from genesis block');
				throw Error(e);
			}
			cb(null, appConfig);
		},

		logger: function (cb) {
			cb(null, logger);
		},

		build: function (cb) {
			cb(null, versionBuild);
		},

		genesisblock: function (cb) {
			cb(null, {
				block: genesisblock
			});
		},

		schema: function (cb) {
			var schema = new z_schema(appConfig.network).z_schema
			cb(null, new schema());
		},

		network: ['config', function (scope, cb) {
			var express = require('express');
			var compression = require('compression');
			var cors = require('cors');
			var app = express();

			require('./helpers/request-limiter')(app, appConfig);

			app.use(compression({ level: 6 }));
			app.use(cors());
			app.options('*', cors());

			var server = require('http').createServer(app);
			var io = require('socket.io')(server);

			var privateKey, certificate, https, https_io;

			if (scope.config.ssl.enabled) {
				privateKey = fs.readFileSync(scope.config.ssl.options.key);
				certificate = fs.readFileSync(scope.config.ssl.options.cert);

				https = require('https').createServer({
					key: privateKey,
					cert: certificate,
					ciphers: 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:' + 'ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:' + '!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA'
				}, app);

				https_io = require('socket.io')(https);
			}

			cb(null, {
				express: express,
				app: app,
				server: server,
				io: io,
				https: https,
				https_io: https_io
			});
		}],</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO: to move to modules/transactions.js ?
To be deprecated in favor of blocksequence, encapsulating unconfirmed tx application in a blocksequence.
To balance transaction application (unconfirmed and confirmed)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		transactionSequence: [<span class="hljs-string">'logger'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> sequence = <span class="hljs-keyword">new</span> Sequence({
				<span class="hljs-attr">onWarning</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">current, limit</span>) </span>{
					scope.logger.warn(<span class="hljs-string">'Transaction queue'</span>, current);
				}
			});
			cb(<span class="hljs-literal">null</span>, sequence);
		}],</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>To balance block processing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		blockSequence: [<span class="hljs-string">'logger'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> sequence = <span class="hljs-keyword">new</span> Sequence({
				<span class="hljs-attr">onWarning</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">current, limit</span>) </span>{
					scope.logger.warn(<span class="hljs-string">'Block queue'</span>, current);
				}
			});
			cb(<span class="hljs-literal">null</span>, sequence);
		}],</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>To balance logic (rebuilding, syncing, downloading blocks, swapping blocks, etc…)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		managementSequence: [<span class="hljs-string">'logger'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> sequence = <span class="hljs-keyword">new</span> Sequence({
				<span class="hljs-attr">onWarning</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">current, limit</span>) </span>{
					scope.logger.warn(<span class="hljs-string">'Block queue'</span>, current);
				}
			});
			cb(<span class="hljs-literal">null</span>, sequence);
		}],</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>To balance db write</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		dbSequence: [<span class="hljs-string">'logger'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> sequence = <span class="hljs-keyword">new</span> Sequence({
				<span class="hljs-attr">onWarning</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">current, limit</span>) </span>{
					scope.logger.warn(<span class="hljs-string">'DB queue'</span>, current);
				}
			});
			cb(<span class="hljs-literal">null</span>, sequence);
		}],</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>To balance block reception via API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		receiveBlockSequence: [<span class="hljs-string">'logger'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> sequence = <span class="hljs-keyword">new</span> Sequence({
				<span class="hljs-attr">onWarning</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">current, limit</span>) </span>{
					scope.logger.warn(<span class="hljs-string">'Receive Block queue'</span>, current);
				}
			});
			cb(<span class="hljs-literal">null</span>, sequence);
		}],</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>To balance API calls</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		balancesSequence: [<span class="hljs-string">'logger'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> sequence = <span class="hljs-keyword">new</span> Sequence({
				<span class="hljs-attr">onWarning</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">current, limit</span>) </span>{
					scope.logger.warn(<span class="hljs-string">'Balance queue'</span>, current);
				}
			});
			cb(<span class="hljs-literal">null</span>, sequence);
		}],

		<span class="hljs-attr">connect</span>: [<span class="hljs-string">'config'</span>, <span class="hljs-string">'genesisblock'</span>, <span class="hljs-string">'logger'</span>, <span class="hljs-string">'build'</span>, <span class="hljs-string">'network'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
			<span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);
			<span class="hljs-keyword">var</span> methodOverride = <span class="hljs-built_in">require</span>(<span class="hljs-string">'method-override'</span>);
			<span class="hljs-keyword">var</span> requestSanitizer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers/request-sanitizer'</span>);
			<span class="hljs-keyword">var</span> queryParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-query-int'</span>);

			scope.network.app.engine(<span class="hljs-string">'html'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'ejs'</span>).renderFile);
			scope.network.app.use(bodyParser.raw({<span class="hljs-attr">limit</span>: <span class="hljs-string">'4mb'</span>}));
			scope.network.app.use(bodyParser.urlencoded({<span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">limit</span>: <span class="hljs-string">'2mb'</span>, <span class="hljs-attr">parameterLimit</span>: <span class="hljs-number">5000</span>}));
			scope.network.app.use(bodyParser.json({<span class="hljs-attr">limit</span>: <span class="hljs-string">'4mb'</span>}));
			scope.network.app.use(methodOverride());

			<span class="hljs-keyword">var</span> ignore = [<span class="hljs-string">'id'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'lastBlockId'</span>, <span class="hljs-string">'blockId'</span>, <span class="hljs-string">'transactionId'</span>, <span class="hljs-string">'address'</span>, <span class="hljs-string">'recipientId'</span>, <span class="hljs-string">'senderId'</span>, <span class="hljs-string">'previousBlock'</span>];

			scope.network.app.use(queryParser({
				<span class="hljs-attr">parser</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value, radix, name</span>) </span>{
					<span class="hljs-keyword">if</span> (ignore.indexOf(name) &gt;= <span class="hljs-number">0</span>) {
						<span class="hljs-keyword">return</span> value;
					}

					<span class="hljs-comment">/*jslint eqeq: true*/</span>
					<span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(value) || <span class="hljs-built_in">parseInt</span>(value) != value || <span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseInt</span>(value, radix))) {
						<span class="hljs-keyword">return</span> value;
					}

					<span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(value);
				}
			}));

			scope.network.app.use(<span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers/z_schema-express.js'</span>)(scope.schema));

			scope.network.app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
				<span class="hljs-keyword">var</span> parts = req.url.split(<span class="hljs-string">'/'</span>);
				<span class="hljs-keyword">var</span> ip = req.headers[<span class="hljs-string">'x-forwarded-for'</span>] || req.connection.remoteAddress;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Log client connections</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				logger.trace(req.method + <span class="hljs-string">' '</span> + req.url + <span class="hljs-string">' from '</span> + ip + <span class="hljs-string">":"</span> + req.headers.port);
				<span class="hljs-comment">/* Instruct browser to deny display of &lt;frame&gt;, &lt;iframe&gt; regardless of origin.
				 *
				 * RFC -&gt; https://tools.ietf.org/html/rfc7034
				 */</span>
				res.setHeader(<span class="hljs-string">'X-Frame-Options'</span>, <span class="hljs-string">'DENY'</span>);

				<span class="hljs-comment">/* Set Content-Security-Policy headers.
				 *
				 * frame-ancestors - Defines valid sources for &lt;frame&gt;, &lt;iframe&gt;, &lt;object&gt;, &lt;embed&gt; or &lt;applet&gt;.
				 *
				 * W3C Candidate Recommendation -&gt; https://www.w3.org/TR/CSP/
				 */</span>
				res.setHeader(<span class="hljs-string">'Content-Security-Policy'</span>, <span class="hljs-string">'frame-ancestors \'none\''</span>);

				<span class="hljs-keyword">if</span> (parts.length &gt; <span class="hljs-number">1</span>) {
					<span class="hljs-keyword">if</span> (parts[<span class="hljs-number">1</span>] === <span class="hljs-string">'api'</span>) {
						<span class="hljs-keyword">if</span> (!checkIpInList(scope.config.api.access.whiteList, ip, <span class="hljs-literal">true</span>)) {
							res.sendStatus(<span class="hljs-number">403</span>);
						} <span class="hljs-keyword">else</span> {
							next();
						}
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parts[<span class="hljs-number">1</span>] === <span class="hljs-string">'peer'</span>) {
						<span class="hljs-keyword">if</span> (checkIpInList(scope.config.peers.blackList, ip, <span class="hljs-literal">false</span>)) {
							res.sendStatus(<span class="hljs-number">403</span>);
						} <span class="hljs-keyword">else</span> {
							next();
						}
					} <span class="hljs-keyword">else</span> {
						next();
					}
				} <span class="hljs-keyword">else</span> {
					next();
				}
			});

			scope.network.server.listen(scope.config.port, scope.config.address, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
				scope.logger.info(<span class="hljs-string">'# Ripa node server started on: '</span> + scope.config.address + <span class="hljs-string">':'</span> + scope.config.port);

				<span class="hljs-keyword">if</span> (!err) {
					<span class="hljs-keyword">if</span> (scope.config.ssl.enabled) {
						scope.network.https.listen(scope.config.ssl.options.port, scope.config.ssl.options.address, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
							scope.logger.info(<span class="hljs-string">'Ripa https started: '</span> + scope.config.ssl.options.address + <span class="hljs-string">':'</span> + scope.config.ssl.options.port);

							cb(err, scope.network);
						});
					} <span class="hljs-keyword">else</span> {
						cb(<span class="hljs-literal">null</span>, scope.network);
					}
				} <span class="hljs-keyword">else</span> {
					cb(err, scope.network);
				}
			});

			<span class="hljs-keyword">if</span>(program.interactive){
				startInteractiveMode(scope);
			}

		}],

		<span class="hljs-attr">crypto</span>: [<span class="hljs-string">'config'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers/crypto.js'</span>)
			cb(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> crypto(scope));
		}],

		<span class="hljs-attr">bus</span>: [<span class="hljs-string">'crypto'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> changeCase = <span class="hljs-built_in">require</span>(<span class="hljs-string">'change-case'</span>);
			<span class="hljs-keyword">var</span> bus = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">this</span>.message = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
					<span class="hljs-keyword">var</span> args = [];
					<span class="hljs-built_in">Array</span>.prototype.push.apply(args, <span class="hljs-built_in">arguments</span>);
					<span class="hljs-keyword">var</span> topic = args.shift();
					modules.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">module</span>) </span>{
						<span class="hljs-keyword">var</span> eventName = <span class="hljs-string">'on'</span> + changeCase.pascalCase(topic);
						<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">module</span>[eventName]) === <span class="hljs-string">'function'</span>) {
							<span class="hljs-built_in">module</span>[eventName].apply(<span class="hljs-built_in">module</span>[eventName], args);
						}
					});
				};
			};
			cb(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> bus());
		}],

		<span class="hljs-attr">db</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{
			<span class="hljs-keyword">var</span> db = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helpers/database.js'</span>);
			db.connect(config.db, logger, cb);
		},

		<span class="hljs-attr">logic</span>: [<span class="hljs-string">'db'</span>, <span class="hljs-string">'bus'</span>, <span class="hljs-string">'schema'</span>, <span class="hljs-string">'genesisblock'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> Transaction = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./logic/transaction.js'</span>);
			<span class="hljs-keyword">var</span> Block = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./logic/block.js'</span>);
			<span class="hljs-keyword">var</span> Account = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./logic/account.js'</span>);

			<span class="hljs-keyword">async</span>.auto({
				<span class="hljs-attr">bus</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{
					cb(<span class="hljs-literal">null</span>, scope.bus);
				},
				<span class="hljs-attr">db</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{
					cb(<span class="hljs-literal">null</span>, scope.db);
				},
				<span class="hljs-attr">crypto</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{
					cb(<span class="hljs-literal">null</span>, scope.crypto);
				},
				<span class="hljs-attr">logger</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{
					cb(<span class="hljs-literal">null</span>, logger);
				},
				<span class="hljs-attr">schema</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{
					cb(<span class="hljs-literal">null</span>, scope.schema);
				},
				<span class="hljs-attr">genesisblock</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{
					cb(<span class="hljs-literal">null</span>, {
						<span class="hljs-attr">block</span>: genesisblock
					});
				},
				<span class="hljs-attr">account</span>: [<span class="hljs-string">'db'</span>, <span class="hljs-string">'bus'</span>, <span class="hljs-string">'crypto'</span>, <span class="hljs-string">'schema'</span>, <span class="hljs-string">'genesisblock'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
					<span class="hljs-keyword">new</span> Account(scope, cb);
				}],
				<span class="hljs-attr">transaction</span>: [<span class="hljs-string">'db'</span>, <span class="hljs-string">'bus'</span>, <span class="hljs-string">'crypto'</span>, <span class="hljs-string">'schema'</span>, <span class="hljs-string">'genesisblock'</span>, <span class="hljs-string">'account'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
					<span class="hljs-keyword">new</span> Transaction(scope, cb);
				}],
				<span class="hljs-attr">block</span>: [<span class="hljs-string">'db'</span>, <span class="hljs-string">'bus'</span>, <span class="hljs-string">'crypto'</span>, <span class="hljs-string">'schema'</span>, <span class="hljs-string">'genesisblock'</span>, <span class="hljs-string">'account'</span>, <span class="hljs-string">'transaction'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
					<span class="hljs-keyword">new</span> Block(scope, cb);
				}]
			}, cb);
		}],

		<span class="hljs-attr">modules</span>: [<span class="hljs-string">'network'</span>, <span class="hljs-string">'connect'</span>, <span class="hljs-string">'config'</span>, <span class="hljs-string">'logger'</span>, <span class="hljs-string">'bus'</span>, <span class="hljs-string">'managementSequence'</span>, <span class="hljs-string">'blockSequence'</span>, <span class="hljs-string">'transactionSequence'</span>, <span class="hljs-string">'dbSequence'</span>, <span class="hljs-string">'balancesSequence'</span>, <span class="hljs-string">'db'</span>, <span class="hljs-string">'logic'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			<span class="hljs-keyword">var</span> tasks = {};

			<span class="hljs-built_in">Object</span>.keys(config.modules).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) </span>{
				tasks[name] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">cb</span>) </span>{
					<span class="hljs-keyword">var</span> d = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create();

					d.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
						scope.logger.fatal(<span class="hljs-string">'Domain '</span> + name, {<span class="hljs-attr">message</span>: err.message, <span class="hljs-attr">stack</span>: err.stack});
					});

					d.run(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
						logger.debug(<span class="hljs-string">'Loading module'</span>, name);
						<span class="hljs-keyword">var</span> Klass = <span class="hljs-built_in">require</span>(config.modules[name]);
						<span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">new</span> Klass(cb, scope);
						modules.push(obj);
					});
				};
			});

			<span class="hljs-keyword">async</span>.parallel(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, results</span>) </span>{
				cb(err, results);
			});
		}],

		<span class="hljs-attr">ready</span>: [<span class="hljs-string">'modules'</span>, <span class="hljs-string">'bus'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">scope, cb</span>) </span>{
			scope.bus.message(<span class="hljs-string">'bind'</span>, scope.modules);
			cb();
		}]
	}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, scope</span>) </span>{
		<span class="hljs-keyword">if</span> (err) {
			scope.logger.fatal(err);
		} <span class="hljs-keyword">else</span> {

			scope.logger.info(<span class="hljs-string">'Modules ready and launched'</span>);

			scope.modules.nodeManager.startApp();

			process.once(<span class="hljs-string">'cleanup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
				scope.logger.info(<span class="hljs-string">'Cleaning up...'</span>);
				<span class="hljs-keyword">async</span>.eachSeries(modules, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">module, cb</span>) </span>{
					<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">module</span>.cleanup) === <span class="hljs-string">'function'</span>) {
						<span class="hljs-built_in">module</span>.cleanup(cb);
					} <span class="hljs-keyword">else</span> {
						cb();
					}
				}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
					<span class="hljs-keyword">if</span> (err) {
						scope.logger.error(err);
					} <span class="hljs-keyword">else</span> {
						scope.logger.info(<span class="hljs-string">'Cleaned up successfully'</span>);
					}
					process.exit(<span class="hljs-number">1</span>);
				});
			});

			process.once(<span class="hljs-string">'SIGTERM'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
				scope.logger.info(<span class="hljs-string">'caught SIGTERM'</span>);
				process.emit(<span class="hljs-string">'cleanup'</span>);
			});

			process.once(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
				scope.logger.info(<span class="hljs-string">'caught internal exit'</span>);
				process.emit(<span class="hljs-string">'cleanup'</span>);
			});

			process.once(<span class="hljs-string">'SIGINT'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
				scope.logger.info(<span class="hljs-string">'caught SIGINT'</span>);
				process.emit(<span class="hljs-string">'cleanup'</span>);
			});
		}
	});
});

process.on(<span class="hljs-string">'uncaughtException'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
          
            <div class="annotation">
          
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Handle error safely</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	logger.fatal(<span class="hljs-string">'System error'</span>, { <span class="hljs-attr">message</span>: err.message, <span class="hljs-attr">stack</span>: err.stack });
	process.emit(<span class="hljs-string">'cleanup'</span>);
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startInteractiveMode</span>(<span class="hljs-params">scope</span>)</span>{
	vorpal
	  .command(<span class="hljs-string">'rebuild'</span>, <span class="hljs-string">'Rebuild node from scratch'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
	    <span class="hljs-keyword">this</span>.log(<span class="hljs-string">'Not Implemented'</span>);
	    callback();
	  });

	vorpal
	  .command(<span class="hljs-string">'status'</span>, <span class="hljs-string">'Send status of the node'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
			<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
			scope.modules.loader.getNetwork(<span class="hljs-literal">true</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, network</span>)</span>{
				<span class="hljs-keyword">var</span> lastBlock = scope.modules.blockchain.getLastBlock();
				self.log(<span class="hljs-string">"Network Height:"</span>, network.height);
				self.log(<span class="hljs-string">"Node Height:"</span>, lastBlock.height, network.height&gt;lastBlock.height?colors.red(<span class="hljs-string">"(not sync)"</span>):colors.green(<span class="hljs-string">"(in sync)"</span>));
				callback();
			});
			self.log(<span class="hljs-string">"Forging:"</span>, scope.modules.delegates.isForging());
			self.log(<span class="hljs-string">"Active Delegate:"</span>, scope.modules.delegates.isActiveDelegate());
			<span class="hljs-keyword">var</span> peers = scope.modules.peers.listBroadcastPeers();
			self.log(<span class="hljs-string">"Connected Peers:"</span>, peers.length);
			self.log(<span class="hljs-string">"Mempool size:"</span>, scope.modules.transactionPool.getMempoolSize());

	  });

	<span class="hljs-keyword">var</span> tail;

	vorpal
	  .command(<span class="hljs-string">'log start'</span>, <span class="hljs-string">'Start output logs'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
			<span class="hljs-keyword">var</span> self=<span class="hljs-keyword">this</span>;
			<span class="hljs-keyword">if</span>(tail){
				self.log(<span class="hljs-string">"Already listening to logs"</span>);
				<span class="hljs-keyword">return</span> callback();
			}
			tail = spawn(<span class="hljs-string">'tail'</span>, [<span class="hljs-string">'-f'</span>, appConfig.logFileName]);
			tail.stdout.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
			  self.log(data.toString(<span class="hljs-string">"UTF-8"</span>));
			});
			callback();
	  });

	vorpal
	  .command(<span class="hljs-string">'log stop'</span>, <span class="hljs-string">'Stop output logs'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
			<span class="hljs-keyword">var</span> self=<span class="hljs-keyword">this</span>;
			<span class="hljs-keyword">if</span>(tail){
				tail.kill();
				tail=<span class="hljs-literal">null</span>;
			}
			callback();
	  });

	vorpal
	  .command(<span class="hljs-string">'log grep &lt;query&gt;'</span>, <span class="hljs-string">'Grep logs with &lt;query&gt;'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
			<span class="hljs-keyword">var</span> self=<span class="hljs-keyword">this</span>;
			<span class="hljs-keyword">var</span> grep = spawn(<span class="hljs-string">'grep'</span>, [<span class="hljs-string">'-e'</span>, args.query, appConfig.logFileName]);
			grep.stdout.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
			  self.log(data.toString(<span class="hljs-string">"UTF-8"</span>));
			});
			callback();
	  });

	vorpal
	  .command(<span class="hljs-string">'update node'</span>, <span class="hljs-string">'force update from network'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
			<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
	    scope.bus.message(<span class="hljs-string">"updatePeers"</span>);
	    callback();
	  });

	vorpal
	  .command(<span class="hljs-string">'sql &lt;query&gt;'</span>, <span class="hljs-string">'query database'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
			<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
	    scope.db.query(args.query).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rows</span>)</span>{
				self.log(rows.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">row</span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.stringify(row)}).join(<span class="hljs-string">"\n"</span>));
				callback();
			}).catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>)</span>{
				self.log(error);
				callback();
			});

	  });

	vorpal
	  .command(<span class="hljs-string">'create account'</span>, <span class="hljs-string">'generate a new random account'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
			<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
	    <span class="hljs-keyword">var</span> passphrase = <span class="hljs-built_in">require</span>(<span class="hljs-string">"bip39"</span>).generateMnemonic();
			self.log(<span class="hljs-string">"Seed    - private:"</span>,passphrase);
			self.log(<span class="hljs-string">"WIF     - private:"</span>,<span class="hljs-built_in">require</span>(<span class="hljs-string">"ripajs"</span>).crypto.getKeys(passphrase).toWIF());
			self.log(<span class="hljs-string">"Address - public :"</span>,<span class="hljs-built_in">require</span>(<span class="hljs-string">"ripajs"</span>).crypto.getAddress(<span class="hljs-built_in">require</span>(<span class="hljs-string">"ripajs"</span>).crypto.getKeys(passphrase).publicKey));
			callback();
	  });
	<span class="hljs-keyword">var</span> account=<span class="hljs-literal">null</span>;
	vorpal
	  .mode(<span class="hljs-string">'account &lt;address&gt;'</span>, <span class="hljs-string">'get info of account (balance, vote, username, publicKey etc...)'</span>)
	  .delimiter(<span class="hljs-string">'account&gt;'</span>)
	  .init(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>)</span>{
	    <span class="hljs-keyword">var</span> self=<span class="hljs-keyword">this</span>;
			scope.db.query(<span class="hljs-string">"select * from mem_accounts where address ='"</span>+args.address+<span class="hljs-string">"'"</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rows</span>)</span>{
				account=rows[<span class="hljs-number">0</span>];
				self.log(<span class="hljs-string">'Managing account '</span>+args.address+<span class="hljs-string">'. Commands: '</span>+<span class="hljs-built_in">Object</span>.keys(account).join(<span class="hljs-string">", "</span>)+<span class="hljs-string">'. To exit, type `exit`.'</span>);
				callback();
			}).catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>)</span>{
				account={};
				self.log(<span class="hljs-string">'Account not found '</span>+args.address+<span class="hljs-string">'. To exit, type `exit`.'</span>);
				callback();
			});
	  })
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">command, callback</span>) </span>{
	    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
	    <span class="hljs-keyword">this</span>.log(account[command]);
			callback();
	  });

		vorpal
		  .command(<span class="hljs-string">'spv fix'</span>, <span class="hljs-string">'fix database using SPV on all accounts'</span>)
		  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
				<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
				scope.modules.nodeManager.fixDatabase(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, results</span>)</span>{
					<span class="hljs-keyword">if</span>(err) self.log(colors.red(err));
					<span class="hljs-keyword">else</span> self.log(<span class="hljs-string">"Fixed "</span>+results[<span class="hljs-number">3</span>].length+<span class="hljs-string">" accounts"</span>);
					callback();
				});
		  });

	vorpal
	  .command(<span class="hljs-string">'spv &lt;address&gt;'</span>, <span class="hljs-string">'Perform Simple Payment Verification against the blockchain'</span>)
	  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args, callback</span>) </span>{
			scope.db.query(<span class="hljs-string">"select * from mem_accounts where address ='"</span>+args.address+<span class="hljs-string">"'"</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rows</span>)</span>{
				<span class="hljs-keyword">var</span> publicKey=rows[<span class="hljs-number">0</span>].publicKey.toString(<span class="hljs-string">"hex"</span>);
				<span class="hljs-keyword">var</span> receivedSQL=<span class="hljs-string">'select sum(amount) as total, count(amount) as count from transactions where amount &gt; 0 and "recipientId" = \''</span>+args.address+<span class="hljs-string">'\';'</span>
				<span class="hljs-keyword">var</span> spentSQL=<span class="hljs-string">'select sum(amount+fee) as total, count(amount) as count from transactions where "senderPublicKey" = \'\\x'</span>+publicKey+<span class="hljs-string">'\';'</span>
				<span class="hljs-keyword">var</span> rewardsSQL=<span class="hljs-string">'select sum(reward+"totalFee") as total, count(reward) as count from blocks where "generatorPublicKey" = \'\\x'</span>+publicKey+<span class="hljs-string">'\';'</span>
				<span class="hljs-keyword">async</span>.series({
					<span class="hljs-attr">received</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>)</span>{
						scope.db.query(receivedSQL).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rows</span>)</span>{
							cb(<span class="hljs-literal">null</span>, rows[<span class="hljs-number">0</span>]);
						});
					},
					<span class="hljs-attr">spent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>)</span>{
						scope.db.query(spentSQL).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rows</span>)</span>{
							cb(<span class="hljs-literal">null</span>, rows[<span class="hljs-number">0</span>]);
						});
					},
					<span class="hljs-attr">rewards</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>)</span>{
						scope.db.query(rewardsSQL).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rows</span>)</span>{
							cb(<span class="hljs-literal">null</span>, rows[<span class="hljs-number">0</span>]);
						});
					}
				}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, result</span>)</span>{
					result.balance = <span class="hljs-built_in">parseInt</span>(result.received.total||<span class="hljs-number">0</span>) - <span class="hljs-built_in">parseInt</span>(result.spent.total||<span class="hljs-number">0</span>) + <span class="hljs-built_in">parseInt</span>(result.rewards.total||<span class="hljs-number">0</span>);
					result.numberOfTransactions = <span class="hljs-built_in">parseInt</span>(result.received.count||<span class="hljs-number">0</span>) + <span class="hljs-built_in">parseInt</span>(result.spent.count||<span class="hljs-number">0</span>)
					result.forgedBlocks =<span class="hljs-built_in">parseInt</span>(result.rewards.count||<span class="hljs-number">0</span>);
					self.log(<span class="hljs-built_in">JSON</span>.stringify(result));
				});
				callback();
			}).catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>)</span>{
				self.log(<span class="hljs-string">'Account not found '</span>+args.address);
				callback();
			});
			<span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

	  });

	vorpal.history(<span class="hljs-string">'ripa-node'</span>);

	vorpal
	  .delimiter(<span class="hljs-string">'ripa-node&gt;'</span>)
	  .show();
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
